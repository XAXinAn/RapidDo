# SpeedCalendar-Server 后端接口文档

> **文档说明**: 本文档详细描述了SpeedCalendar-Server项目的所有API接口规格，供前端开发使用。
> **重要提示**: 前端重构时请严格按照此文档调用接口，保持接口契约不变。

---

## 目录

1. [项目概述](#项目概述)
2. [通用说明](#通用说明)
3. [认证模块API](#认证模块api)
4. [头像管理API](#头像管理api)
5. [隐私设置API](#隐私设置api)
6. [文件访问API](#文件访问api)
7. [数据模型](#数据模型)
8. [错误码说明](#错误码说明)
9. [完整调用示例](#完整调用示例)

---

## 项目概述

### 技术栈
- **后端框架**: Spring Boot 3.5.7
- **数据库**: MySQL 8.0+
- **缓存**: Redis
- **认证**: JWT (JSON Web Token)
- **密码加密**: BCrypt
- **语言版本**: Java 21

### 服务信息
- **基础URL**: `http://localhost:8080/api` (开发环境)
- **生产URL**: 根据实际部署配置
- **API前缀**: `/api`
- **默认端口**: 8080

---

## 通用说明

### 统一响应格式

所有API接口返回统一的JSON格式：

```json
{
  "code": 200,
  "message": "操作成功",
  "data": {}
}
```

**字段说明**:
- `code`: HTTP状态码，200表示成功
- `message`: 操作提示信息
- `data`: 响应数据，可能是对象、数组或null

### 认证方式

大部分接口需要在请求头中携带JWT Token：

```http
Authorization: Bearer eyJhbGciOiJIUzI1NiJ9...
```

**Token说明**:
- **AccessToken**: 有效期2小时，用于接口调用
- **RefreshToken**: 有效期30天，用于刷新AccessToken（当前未实现刷新接口）

### Content-Type

- JSON请求: `application/json`
- 文件上传: `multipart/form-data`

---

## 认证模块API

**基础路径**: `/api/auth`

### 1. 健康检查

**接口**: `GET /api/auth/health`

**功能**: 检查服务是否正常运行

**是否需要Token**: ❌ 否

**请求示例**:
```bash
curl http://localhost:8080/api/auth/health
```

**响应示例**:
```json
{
  "code": 200,
  "message": "服务正常",
  "data": "SpeedCalendar Auth Service is running"
}
```

---

### 2. 发送验证码

**接口**: `POST /api/auth/code`

**功能**: 向手机号发送登录验证码

**是否需要Token**: ❌ 否

**Content-Type**: `application/json`

**请求参数**:
| 参数名 | 类型 | 必填 | 验证规则 | 说明 |
|--------|------|------|----------|------|
| phone | String | ✅ 是 | 格式: `^1[3-9]\d{9}$` | 11位手机号 |

**请求示例**:
```bash
curl -X POST http://localhost:8080/api/auth/code \
  -H "Content-Type: application/json" \
  -d '{
    "phone": "13800138000"
  }'
```

**成功响应**:
```json
{
  "code": 200,
  "message": "验证码发送成功",
  "data": null
}
```

**错误响应示例**:

1. 手机号格式错误
```json
{
  "code": 400,
  "message": "手机号格式不正确",
  "data": null
}
```

2. 发送过于频繁
```json
{
  "code": 500,
  "message": "发送过于频繁，请60秒后再试",
  "data": null
}
```

3. 超过每日限额
```json
{
  "code": 500,
  "message": "今日发送次数已达上限",
  "data": null
}
```

**业务规则**:
- 发送间隔: 60秒
- 每日限额: 10次/手机号
- 验证码长度: 6位数字
- 有效期: 5分钟
- 验证码会在后端日志中打印（开发环境）

---

### 3. 手机号登录

**接口**: `POST /api/auth/login/phone`

**功能**: 使用手机号+验证码登录，首次登录自动注册

**是否需要Token**: ❌ 否

**Content-Type**: `application/json`

**请求参数**:
| 参数名 | 类型 | 必填 | 验证规则 | 说明 |
|--------|------|------|----------|------|
| phone | String | ✅ 是 | 格式: `^1[3-9]\d{9}$` | 手机号 |
| code | String | ✅ 是 | 长度: 6位 | 验证码 |

**请求示例**:
```bash
curl -X POST http://localhost:8080/api/auth/login/phone \
  -H "Content-Type: application/json" \
  -d '{
    "phone": "13800138000",
    "code": "123456"
  }'
```

**成功响应**:
```json
{
  "code": 200,
  "message": "登录成功",
  "data": {
    "userId": "d60347da-da6f-4d3e-8adc-0bcdbba53692",
    "token": "eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJkNjAzNDdkYS1kYTZmLTRkM2UtOGFkYy0wYmNkYmJhNTM2OTIiLCJpYXQiOjE3MzI0MzQwMDAsImV4cCI6MTczMjQ0MTIwMH0.xxx",
    "refreshToken": "eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJkNjAzNDdkYS1kYTZmLTRkM2UtOGFkYy0wYmNkYmJhNTM2OTIiLCJpYXQiOjE3MzI0MzQwMDAsImV4cCI6MTczNTAyNjAwMH0.xxx",
    "expiresIn": 7200,
    "userInfo": {
      "userId": "d60347da-da6f-4d3e-8adc-0bcdbba53692",
      "phone": "13800138000",
      "email": null,
      "username": "用户8000",
      "avatar": "https://api.dicebear.com/7.x/initials/svg?seed=用户8000",
      "gender": 0,
      "birthday": null,
      "bio": null,
      "loginType": "phone",
      "createdAt": "2025-11-16T10:00:00"
    }
  }
}
```

**响应字段说明**:
- `userId`: 用户唯一ID（UUID格式）
- `token`: AccessToken，有效期2小时
- `refreshToken`: RefreshToken，有效期30天
- `expiresIn`: Token有效期（秒）
- `userInfo`: 用户信息对象

**错误响应示例**:

1. 验证码错误
```json
{
  "code": 400,
  "message": "验证码错误或已失效",
  "data": null
}
```

2. 验证码过期
```json
{
  "code": 400,
  "message": "验证码已过期",
  "data": null
}
```

**业务逻辑**:
1. 验证验证码是否正确且未过期
2. 如果用户不存在，自动创建新用户：
   - 生成UUID作为用户ID
   - 默认昵称: "用户{手机号后4位}"
   - 默认头像: 使用DiceBear生成的初始头像
   - 性别默认: 0（未知）
3. 生成JWT Token对
4. 保存Token记录到数据库
5. 返回登录信息

---

### 4. 获取用户信息

**接口**: `GET /api/auth/user/{userId}?requesterId={requesterId}`

**功能**: 获取指定用户信息，支持隐私过滤

**是否需要Token**: ⚠️ 建议携带（虽然接口层面未强制）

**路径参数**:
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| userId | String | ✅ 是 | 目标用户ID |

**查询参数**:
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| requesterId | String | ❌ 否 | 请求者ID，用于隐私过滤 |

**请求示例**:
```bash
# 获取自己的信息（完整）
curl http://localhost:8080/api/auth/user/{myUserId}?requesterId={myUserId}

# 获取他人信息（隐私过滤）
curl http://localhost:8080/api/auth/user/{otherUserId}?requesterId={myUserId}

# 不提供requesterId（返回完整信息）
curl http://localhost:8080/api/auth/user/{userId}
```

**成功响应**:
```json
{
  "code": 200,
  "message": "获取成功",
  "data": {
    "userId": "d60347da-da6f-4d3e-8adc-0bcdbba53692",
    "phone": "138****8000",
    "email": null,
    "username": "用户昵称",
    "avatar": "https://api.dicebear.com/7.x/initials/svg?seed=用户昵称",
    "gender": 1,
    "birthday": "1990-01-01",
    "bio": "这是我的个人简介",
    "loginType": "phone",
    "createdAt": "2025-11-16T10:00:00"
  }
}
```

**隐私过滤规则**:

根据用户的隐私设置，某些字段可能被隐藏或脱敏：

| 字段 | 默认可见性 | PRIVATE时 | FRIENDS_ONLY时 |
|------|-----------|-----------|----------------|
| phone | PRIVATE | null | null |
| email | FRIENDS_ONLY | null | null |
| birthday | FRIENDS_ONLY | null | null |
| gender | PUBLIC | 显示 | 显示 |
| bio | PUBLIC | 显示 | 显示 |

**特殊情况**:
- 如果 `requesterId == userId`（查看自己）: 返回完整信息
- 如果未提供 `requesterId`: 返回完整信息（兼容旧版本）

---

### 5. 更新用户信息

**接口**: `PUT /api/auth/user/{userId}`

**功能**: 更新用户昵称和头像

**是否需要Token**: ⚠️ 建议携带

**Content-Type**: `application/json`

**路径参数**:
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| userId | String | ✅ 是 | 用户ID |

**请求参数**:
| 参数名 | 类型 | 必填 | 验证规则 | 说明 |
|--------|------|------|----------|------|
| username | String | ❌ 否 | 最大20字符 | 用户昵称 |
| avatar | String | ❌ 否 | - | 头像URL |

**请求示例**:
```bash
curl -X PUT http://localhost:8080/api/auth/user/{userId} \
  -H "Content-Type: application/json" \
  -d '{
    "username": "我的新昵称",
    "avatar": "http://localhost:8080/api/files/avatars/user123_1234567890.jpg"
  }'
```

**成功响应**:
```json
{
  "code": 200,
  "message": "更新成功",
  "data": {
    "userId": "d60347da-da6f-4d3e-8adc-0bcdbba53692",
    "phone": "13800138000",
    "username": "我的新昵称",
    "avatar": "http://localhost:8080/api/files/avatars/user123_1234567890.jpg",
    ...
  }
}
```

**注意事项**:
- 至少提供一个字段（username 或 avatar）
- username长度不能超过20字符
- avatar通常是上传头像后返回的URL

---

## 头像管理API

**基础路径**: `/api/avatar`

### 6. 上传头像

**接口**: `POST /api/avatar/upload`

**功能**: 上传用户头像，自动删除旧头像

**是否需要Token**: ⚠️ 建议携带

**Content-Type**: `multipart/form-data`

**请求参数**:
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| file | File | ✅ 是 | 头像文件 |
| userId | String | ✅ 是 | 用户ID |

**文件限制**:
- 最大大小: 5MB
- 允许格式: jpg, jpeg, png, webp
- 允许MIME类型: image/jpeg, image/png, image/webp

**请求示例**:
```bash
curl -X POST http://localhost:8080/api/avatar/upload \
  -F "file=@/path/to/avatar.jpg" \
  -F "userId=d60347da-da6f-4d3e-8adc-0bcdbba53692"
```

**JavaScript示例**:
```javascript
const formData = new FormData();
formData.append('file', fileInput.files[0]);
formData.append('userId', userId);

fetch('http://localhost:8080/api/avatar/upload', {
  method: 'POST',
  body: formData
})
.then(response => response.json())
.then(data => console.log(data));
```

**成功响应**:
```json
{
  "code": 200,
  "message": "上传成功",
  "data": {
    "avatarUrl": "http://localhost:8080/api/files/avatars/d60347da_1732434000123.jpg"
  }
}
```

**错误响应示例**:

1. 文件为空
```json
{
  "code": 400,
  "message": "文件不能为空",
  "data": null
}
```

2. 文件过大
```json
{
  "code": 413,
  "message": "文件大小不能超过5MB",
  "data": null
}
```

3. 文件类型不支持
```json
{
  "code": 400,
  "message": "不支持的文件类型",
  "data": null
}
```

4. MIME类型不匹配
```json
{
  "code": 400,
  "message": "不支持的文件格式",
  "data": null
}
```

**业务逻辑**:
1. 验证文件存在且不为空
2. 验证文件大小 ≤ 5MB
3. 验证文件扩展名（jpg/jpeg/png/webp）
4. 验证MIME类型
5. 查询用户是否存在
6. 删除旧头像（如果存在且非默认头像）
7. 生成唯一文件名: `{userId}_{timestamp}.{extension}`
8. 保存文件到本地或OSS
9. 更新用户头像URL到数据库
10. 返回新头像URL

**文件命名规则**:
- 格式: `{userId}_{timestamp}.{extension}`
- 示例: `d60347da_1732434000123.jpg`

---

### 7. 删除头像

**接口**: `DELETE /api/avatar/{userId}`

**功能**: 删除用户头像，恢复为默认头像

**是否需要Token**: ⚠️ 建议携带

**路径参数**:
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| userId | String | ✅ 是 | 用户ID |

**请求示例**:
```bash
curl -X DELETE http://localhost:8080/api/avatar/{userId}
```

**成功响应**:
```json
{
  "code": 200,
  "message": "删除成功",
  "data": null
}
```

**业务逻辑**:
1. 查询用户信息
2. 删除头像文件（如果非默认头像）
3. 恢复默认头像: `https://api.dicebear.com/7.x/initials/svg?seed={username}`
4. 更新数据库

---

## 隐私设置API

**基础路径**: `/api/privacy`

### 8. 获取隐私设置

**接口**: `GET /api/privacy/settings/{userId}`

**功能**: 获取用户的所有隐私设置

**是否需要Token**: ⚠️ 建议携带

**路径参数**:
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| userId | String | ✅ 是 | 用户ID |

**请求示例**:
```bash
curl http://localhost:8080/api/privacy/settings/{userId}
```

**成功响应**:
```json
{
  "code": 200,
  "message": "获取成功",
  "data": [
    {
      "fieldName": "phone",
      "displayName": "手机号",
      "visibilityLevel": "PRIVATE"
    },
    {
      "fieldName": "email",
      "displayName": "邮箱",
      "visibilityLevel": "FRIENDS_ONLY"
    },
    {
      "fieldName": "birthday",
      "displayName": "生日",
      "visibilityLevel": "FRIENDS_ONLY"
    },
    {
      "fieldName": "gender",
      "displayName": "性别",
      "visibilityLevel": "PUBLIC"
    },
    {
      "fieldName": "bio",
      "displayName": "个人简介",
      "visibilityLevel": "PUBLIC"
    }
  ]
}
```

**可见性级别说明**:
| 级别 | 值 | 说明 |
|------|---|------|
| 公开 | PUBLIC | 所有人可见 |
| 仅好友 | FRIENDS_ONLY | 仅好友可见（当前等同PRIVATE） |
| 私密 | PRIVATE | 仅自己可见 |

**可设置的字段**:
| 字段名 | 显示名称 | 默认可见性 |
|--------|----------|-----------|
| phone | 手机号 | PRIVATE |
| email | 邮箱 | FRIENDS_ONLY |
| birthday | 生日 | FRIENDS_ONLY |
| gender | 性别 | PUBLIC |
| bio | 个人简介 | PUBLIC |

---

### 9. 批量更新隐私设置

**接口**: `PUT /api/privacy/settings/{userId}`

**功能**: 批量更新用户的隐私设置

**是否需要Token**: ⚠️ 建议携带

**Content-Type**: `application/json`

**路径参数**:
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| userId | String | ✅ 是 | 用户ID |

**请求参数**:
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| settings | Array | ✅ 是 | 隐私设置数组 |

**settings数组元素**:
| 字段 | 类型 | 必填 | 可选值 | 说明 |
|------|------|------|--------|------|
| fieldName | String | ✅ 是 | phone, email, birthday, gender, bio | 字段名 |
| visibilityLevel | String | ✅ 是 | PUBLIC, FRIENDS_ONLY, PRIVATE | 可见性级别 |

**请求示例**:
```bash
curl -X PUT http://localhost:8080/api/privacy/settings/{userId} \
  -H "Content-Type: application/json" \
  -d '{
    "settings": [
      {
        "fieldName": "phone",
        "visibilityLevel": "PRIVATE"
      },
      {
        "fieldName": "email",
        "visibilityLevel": "FRIENDS_ONLY"
      },
      {
        "fieldName": "birthday",
        "visibilityLevel": "FRIENDS_ONLY"
      },
      {
        "fieldName": "gender",
        "visibilityLevel": "PUBLIC"
      },
      {
        "fieldName": "bio",
        "visibilityLevel": "PUBLIC"
      }
    ]
  }'
```

**成功响应**:
```json
{
  "code": 200,
  "message": "更新成功",
  "data": null
}
```

**业务逻辑**:
1. 验证用户存在
2. 验证字段名合法（phone/email/birthday/gender/bio）
3. 验证可见性级别合法（PUBLIC/FRIENDS_ONLY/PRIVATE）
4. 使用 INSERT ... ON DUPLICATE KEY UPDATE 更新数据库
5. 清除用户隐私设置缓存
6. 返回成功

**注意事项**:
- 可以只更新部分字段
- 未提供的字段保持原有设置不变
- 更新后会立即清除缓存，下次查询生效

---

### 10. 清除隐私设置缓存

**接口**: `DELETE /api/privacy/cache/{userId}`

**功能**: 清除指定用户的隐私设置缓存（调试/维护用）

**是否需要Token**: ⚠️ 建议携带

**路径参数**:
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| userId | String | ✅ 是 | 用户ID |

**请求示例**:
```bash
curl -X DELETE http://localhost:8080/api/privacy/cache/{userId}
```

**成功响应**:
```json
{
  "code": 200,
  "message": "缓存已清除",
  "data": null
}
```

**使用场景**:
- 调试隐私功能时
- 数据库直接修改后需要刷新缓存
- 维护或排查问题时

---

## 文件访问API

**基础路径**: `/api/files`

⚠️ **注意**: 此模块仅在本地存储模式下（`file.storage.type=local`）启用

### 11. 访问头像文件

**接口**: `GET /api/files/avatars/{filename}`

**功能**: 访问本地存储的头像文件

**是否需要Token**: ❌ 否

**路径参数**:
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| filename | String | ✅ 是 | 文件名（不含路径） |

**请求示例**:
```bash
curl http://localhost:8080/api/files/avatars/d60347da_1732434000123.jpg
```

**成功响应**:
- 返回图片二进制流
- Content-Type: image/jpeg 或 image/png 或 image/webp
- Cache-Control: max-age=31536000 (缓存1年)

**HTML使用示例**:
```html
<img src="http://localhost:8080/api/files/avatars/d60347da_1732434000123.jpg" alt="用户头像">
```

**注意事项**:
- 生产环境使用OSS时，头像URL直接指向OSS，不经过服务器
- 此接口仅用于开发环境的本地文件访问
- 文件访问不需要认证，公开访问

---

## 数据模型

### UserInfo 用户信息

```typescript
interface UserInfo {
  userId: string;           // 用户ID (UUID格式)
  phone: string | null;     // 手机号 (可能被隐私过滤)
  email: string | null;     // 邮箱 (可能被隐私过滤)
  username: string;         // 用户昵称
  avatar: string;           // 头像URL
  gender: number;           // 性别: 0-未知, 1-男, 2-女 (可能被隐私过滤)
  birthday: string | null;  // 生日 (yyyy-MM-dd格式，可能被隐私过滤)
  bio: string | null;       // 个人简介 (可能被隐私过滤)
  loginType: string;        // 注册方式: "phone" 或 "email"
  createdAt: string;        // 注册时间 (ISO8601格式)
}
```

### LoginResponse 登录响应

```typescript
interface LoginResponse {
  userId: string;           // 用户ID
  token: string;            // AccessToken (JWT)
  refreshToken: string;     // RefreshToken (JWT)
  expiresIn: number;        // Token有效期(秒): 7200 (2小时)
  userInfo: UserInfo;       // 用户信息
}
```

### PrivacySetting 隐私设置

```typescript
interface PrivacySetting {
  fieldName: string;        // 字段名: "phone" | "email" | "birthday" | "gender" | "bio"
  displayName: string;      // 显示名称: "手机号" | "邮箱" | "生日" | "性别" | "个人简介"
  visibilityLevel: string;  // 可见性级别: "PUBLIC" | "FRIENDS_ONLY" | "PRIVATE"
}
```

### UploadAvatarResponse 上传头像响应

```typescript
interface UploadAvatarResponse {
  avatarUrl: string;        // 头像URL
}
```

---

## 错误码说明

### HTTP状态码

| 状态码 | 说明 | 示例场景 |
|--------|------|----------|
| 200 | 成功 | 所有成功的请求 |
| 400 | 请求参数错误 | 参数格式不正确、验证失败 |
| 401 | 未授权 | Token无效或过期 |
| 403 | 无权限访问 | 访问其他用户的私密信息 |
| 404 | 资源不存在 | 用户不存在、文件不存在 |
| 413 | 请求体过大 | 上传文件超过5MB |
| 429 | 请求过于频繁 | 验证码发送频率超限 |
| 500 | 服务器内部错误 | 数据库错误、文件系统错误 |

### 常见错误信息

**验证码相关**:
- "手机号格式不正确"
- "验证码不能为空"
- "验证码必须为6位"
- "发送过于频繁，请60秒后再试"
- "今日发送次数已达上限"
- "验证码错误或已失效"
- "验证码已过期"

**用户相关**:
- "用户不存在"
- "昵称长度不能超过20个字符"

**文件上传相关**:
- "文件不能为空"
- "文件大小不能超过5MB"
- "不支持的文件类型"
- "不支持的文件格式"

---

## 完整调用示例

### 示例1: 完整登录流程

```javascript
// 1. 发送验证码
async function sendVerificationCode(phone) {
  const response = await fetch('http://localhost:8080/api/auth/code', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({ phone })
  });
  const result = await response.json();
  if (result.code === 200) {
    alert('验证码已发送');
  } else {
    alert(result.message);
  }
  return result;
}

// 2. 使用验证码登录
async function login(phone, code) {
  const response = await fetch('http://localhost:8080/api/auth/login/phone', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({ phone, code })
  });
  const result = await response.json();
  if (result.code === 200) {
    // 保存Token
    localStorage.setItem('accessToken', result.data.token);
    localStorage.setItem('refreshToken', result.data.refreshToken);
    localStorage.setItem('userId', result.data.userId);
    localStorage.setItem('userInfo', JSON.stringify(result.data.userInfo));
    return result.data;
  } else {
    throw new Error(result.message);
  }
}

// 使用示例
sendVerificationCode('13800138000')
  .then(() => {
    // 用户输入验证码后
    const code = prompt('请输入验证码');
    return login('13800138000', code);
  })
  .then(loginData => {
    console.log('登录成功', loginData);
  })
  .catch(error => {
    console.error('登录失败', error);
  });
```

---

### 示例2: 获取和更新用户信息

```javascript
// 获取用户信息（带隐私过滤）
async function getUserInfo(userId, requesterId) {
  const url = new URL(`http://localhost:8080/api/auth/user/${userId}`);
  if (requesterId) {
    url.searchParams.append('requesterId', requesterId);
  }

  const response = await fetch(url, {
    headers: {
      'Authorization': `Bearer ${localStorage.getItem('accessToken')}`
    }
  });
  const result = await response.json();
  return result.data;
}

// 更新用户信息
async function updateUserInfo(userId, updates) {
  const response = await fetch(`http://localhost:8080/api/auth/user/${userId}`, {
    method: 'PUT',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${localStorage.getItem('accessToken')}`
    },
    body: JSON.stringify(updates)
  });
  const result = await response.json();
  return result.data;
}

// 使用示例
const myUserId = localStorage.getItem('userId');

// 获取自己的完整信息
getUserInfo(myUserId, myUserId)
  .then(userInfo => {
    console.log('我的信息', userInfo);
  });

// 获取他人信息（隐私过滤）
getUserInfo('other-user-id', myUserId)
  .then(userInfo => {
    console.log('他人信息', userInfo);
  });

// 更新昵称
updateUserInfo(myUserId, { username: '我的新昵称' })
  .then(updatedInfo => {
    console.log('更新成功', updatedInfo);
  });
```

---

### 示例3: 头像上传

```javascript
// 上传头像
async function uploadAvatar(file, userId) {
  const formData = new FormData();
  formData.append('file', file);
  formData.append('userId', userId);

  const response = await fetch('http://localhost:8080/api/avatar/upload', {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${localStorage.getItem('accessToken')}`
    },
    body: formData
  });
  const result = await response.json();
  if (result.code === 200) {
    return result.data.avatarUrl;
  } else {
    throw new Error(result.message);
  }
}

// HTML中的使用
// <input type="file" id="avatarInput" accept="image/jpeg,image/png,image/webp">

document.getElementById('avatarInput').addEventListener('change', async (e) => {
  const file = e.target.files[0];
  if (!file) return;

  // 验证文件大小
  if (file.size > 5 * 1024 * 1024) {
    alert('文件大小不能超过5MB');
    return;
  }

  // 验证文件类型
  const allowedTypes = ['image/jpeg', 'image/png', 'image/webp'];
  if (!allowedTypes.includes(file.type)) {
    alert('只支持 JPG、PNG、WEBP 格式');
    return;
  }

  try {
    const userId = localStorage.getItem('userId');
    const avatarUrl = await uploadAvatar(file, userId);
    console.log('头像上传成功', avatarUrl);

    // 更新用户信息中的头像
    await updateUserInfo(userId, { avatar: avatarUrl });

    // 更新页面上的头像显示
    document.getElementById('userAvatar').src = avatarUrl;
  } catch (error) {
    alert('上传失败: ' + error.message);
  }
});

// 删除头像
async function deleteAvatar(userId) {
  const response = await fetch(`http://localhost:8080/api/avatar/${userId}`, {
    method: 'DELETE',
    headers: {
      'Authorization': `Bearer ${localStorage.getItem('accessToken')}`
    }
  });
  const result = await response.json();
  return result;
}
```

---

### 示例4: 隐私设置管理

```javascript
// 获取隐私设置
async function getPrivacySettings(userId) {
  const response = await fetch(`http://localhost:8080/api/privacy/settings/${userId}`, {
    headers: {
      'Authorization': `Bearer ${localStorage.getItem('accessToken')}`
    }
  });
  const result = await response.json();
  return result.data;
}

// 更新隐私设置
async function updatePrivacySettings(userId, settings) {
  const response = await fetch(`http://localhost:8080/api/privacy/settings/${userId}`, {
    method: 'PUT',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${localStorage.getItem('accessToken')}`
    },
    body: JSON.stringify({ settings })
  });
  const result = await response.json();
  return result;
}

// 使用示例
const userId = localStorage.getItem('userId');

// 获取当前隐私设置
getPrivacySettings(userId)
  .then(settings => {
    console.log('当前隐私设置', settings);
    // [
    //   { fieldName: "phone", displayName: "手机号", visibilityLevel: "PRIVATE" },
    //   { fieldName: "email", displayName: "邮箱", visibilityLevel: "FRIENDS_ONLY" },
    //   ...
    // ]
  });

// 更新隐私设置
const newSettings = [
  { fieldName: "phone", visibilityLevel: "PRIVATE" },
  { fieldName: "email", visibilityLevel: "PUBLIC" },
  { fieldName: "birthday", visibilityLevel: "FRIENDS_ONLY" },
  { fieldName: "gender", visibilityLevel: "PUBLIC" },
  { fieldName: "bio", visibilityLevel: "PUBLIC" }
];

updatePrivacySettings(userId, newSettings)
  .then(result => {
    if (result.code === 200) {
      alert('隐私设置已更新');
    }
  });
```

---

### 示例5: React组件封装

```jsx
import React, { useState, useEffect } from 'react';

// API配置
const API_BASE_URL = 'http://localhost:8080/api';

// API工具类
class SpeedCalendarAPI {
  static async request(endpoint, options = {}) {
    const token = localStorage.getItem('accessToken');
    const headers = {
      ...options.headers,
    };

    if (token && !options.skipAuth) {
      headers['Authorization'] = `Bearer ${token}`;
    }

    if (options.body && !(options.body instanceof FormData)) {
      headers['Content-Type'] = 'application/json';
      options.body = JSON.stringify(options.body);
    }

    const response = await fetch(`${API_BASE_URL}${endpoint}`, {
      ...options,
      headers
    });

    const result = await response.json();

    if (result.code !== 200) {
      throw new Error(result.message);
    }

    return result.data;
  }

  // 认证相关
  static sendCode(phone) {
    return this.request('/auth/code', {
      method: 'POST',
      body: { phone },
      skipAuth: true
    });
  }

  static login(phone, code) {
    return this.request('/auth/login/phone', {
      method: 'POST',
      body: { phone, code },
      skipAuth: true
    });
  }

  static getUserInfo(userId, requesterId) {
    const query = requesterId ? `?requesterId=${requesterId}` : '';
    return this.request(`/auth/user/${userId}${query}`);
  }

  static updateUserInfo(userId, data) {
    return this.request(`/auth/user/${userId}`, {
      method: 'PUT',
      body: data
    });
  }

  // 头像相关
  static uploadAvatar(file, userId) {
    const formData = new FormData();
    formData.append('file', file);
    formData.append('userId', userId);

    return this.request('/avatar/upload', {
      method: 'POST',
      body: formData
    });
  }

  static deleteAvatar(userId) {
    return this.request(`/avatar/${userId}`, {
      method: 'DELETE'
    });
  }

  // 隐私相关
  static getPrivacySettings(userId) {
    return this.request(`/privacy/settings/${userId}`);
  }

  static updatePrivacySettings(userId, settings) {
    return this.request(`/privacy/settings/${userId}`, {
      method: 'PUT',
      body: { settings }
    });
  }
}

// React Hook: 用户信息
function useUserInfo(userId) {
  const [userInfo, setUserInfo] = useState(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);

  useEffect(() => {
    SpeedCalendarAPI.getUserInfo(userId)
      .then(data => {
        setUserInfo(data);
        setLoading(false);
      })
      .catch(err => {
        setError(err.message);
        setLoading(false);
      });
  }, [userId]);

  return { userInfo, loading, error };
}

// React组件: 用户资料卡片
function UserProfileCard({ userId }) {
  const { userInfo, loading, error } = useUserInfo(userId);

  if (loading) return <div>加载中...</div>;
  if (error) return <div>错误: {error}</div>;

  return (
    <div className="user-profile-card">
      <img src={userInfo.avatar} alt={userInfo.username} />
      <h3>{userInfo.username}</h3>
      {userInfo.bio && <p>{userInfo.bio}</p>}
      {userInfo.phone && <p>手机: {userInfo.phone}</p>}
      {userInfo.email && <p>邮箱: {userInfo.email}</p>}
    </div>
  );
}

export { SpeedCalendarAPI, useUserInfo, UserProfileCard };
```

---

## 附录

### A. 默认值说明

**用户注册默认值**:
- 昵称: "用户{手机号后4位}"
- 头像: `https://api.dicebear.com/7.x/initials/svg?seed={username}`
- 性别: 0（未知）
- 状态: 1（正常）
- 注册方式: "phone"

**隐私设置默认值**:
- phone: PRIVATE（仅自己可见）
- email: FRIENDS_ONLY（仅好友可见）
- birthday: FRIENDS_ONLY（仅好友可见）
- gender: PUBLIC（公开）
- bio: PUBLIC（公开）

**Token有效期**:
- AccessToken: 7200秒（2小时）
- RefreshToken: 2592000秒（30天）

**验证码限制**:
- 长度: 6位数字
- 有效期: 300秒（5分钟）
- 发送间隔: 60秒
- 每日限额: 10次/手机号

---

### B. 文件存储说明

**本地存储模式** (`file.storage.type=local`):
- 存储路径: `D:/speedcalendar/uploads/avatars`
- 访问URL: `http://localhost:8080/api/files/avatars/{filename}`
- 适用于: 开发环境

**OSS存储模式** (`file.storage.type=oss`):
- 存储平台: 阿里云OSS
- CDN加速: 可选
- 访问URL: 直接使用OSS返回的URL
- 适用于: 生产环境

---

### C. 数据库表结构

**users 用户表**:
```sql
CREATE TABLE users (
    user_id VARCHAR(64) PRIMARY KEY,
    phone VARCHAR(20) UNIQUE,
    email VARCHAR(100) UNIQUE,
    password VARCHAR(255),
    username VARCHAR(50),
    avatar VARCHAR(500),
    gender TINYINT DEFAULT 0,
    birthday DATE,
    bio VARCHAR(200),
    status TINYINT DEFAULT 1,
    login_type VARCHAR(20) DEFAULT 'phone',
    last_login_time DATETIME,
    last_login_ip VARCHAR(50),
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    is_deleted TINYINT DEFAULT 0
);
```

**verification_codes 验证码表**:
```sql
CREATE TABLE verification_codes (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    phone VARCHAR(20) NOT NULL,
    code VARCHAR(10) NOT NULL,
    type VARCHAR(20) DEFAULT 'login',
    status TINYINT DEFAULT 0,
    ip_address VARCHAR(50),
    expires_at DATETIME NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    used_at DATETIME
);
```

**user_tokens Token表**:
```sql
CREATE TABLE user_tokens (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id VARCHAR(64) NOT NULL,
    access_token VARCHAR(500) UNIQUE NOT NULL,
    refresh_token VARCHAR(500) UNIQUE NOT NULL,
    access_token_expires_at DATETIME NOT NULL,
    refresh_token_expires_at DATETIME NOT NULL,
    device_type VARCHAR(20),
    device_id VARCHAR(100),
    ip_address VARCHAR(50),
    user_agent VARCHAR(500),
    status TINYINT DEFAULT 1,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

**user_privacy_settings 隐私设置表**:
```sql
CREATE TABLE user_privacy_settings (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id VARCHAR(64) NOT NULL,
    field_name VARCHAR(50) NOT NULL,
    visibility_level ENUM('PUBLIC', 'FRIENDS_ONLY', 'PRIVATE') NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    UNIQUE KEY uk_user_field (user_id, field_name)
);
```

---

### D. 待实现功能

以下接口规划中但尚未实现：

1. **Token刷新**: `POST /api/auth/refresh`
2. **邮箱登录**: `POST /api/auth/login/email`
3. **退出登录**: `POST /api/auth/logout`
4. **AI功能模块**: OCR识别、AI翻译、AI写作、图像处理等（详见 AI_API_DOCUMENTATION.md）

---

### E. 开发环境说明

**后端配置**:
- 服务地址: http://localhost:8080
- 数据库: MySQL 8.0+
- 缓存: Redis (可选)
- JWT密钥: 可在 application.yml 中配置

**Android开发注意事项**:
- 使用 `http://10.0.2.2:8080` 访问模拟器的宿主机localhost
- 真机测试需要使用局域网IP或内网穿透

**前端开发建议**:
- 封装统一的API请求类
- 使用拦截器统一处理Token
- 实现Token过期自动刷新（待后端实现刷新接口）
- 使用环境变量管理不同环境的API地址

---

## 完整API响应格式详细说明

本章节详细列出所有API接口的响应字段、类型和说明。

---

### 1. 通用响应格式

所有API都遵循统一的响应格式：

```typescript
interface ApiResponse<T> {
  code: number;      // 响应码：200-成功，其他-失败
  message: string;   // 响应消息
  data: T | null;    // 响应数据，类型根据具体接口而定
}
```

---

### 2. 认证模块响应格式

#### 2.1 健康检查 - `GET /api/auth/health`

```json
{
  "code": 200,
  "message": "服务正常",
  "data": "SpeedCalendar Auth Service is running"
}
```

**data字段类型**: `string`

---

#### 2.2 发送验证码 - `POST /api/auth/code`

```json
{
  "code": 200,
  "message": "验证码发送成功",
  "data": null
}
```

**data字段类型**: `null`

---

#### 2.3 手机号登录 - `POST /api/auth/login/phone`

```json
{
  "code": 200,
  "message": "登录成功",
  "data": {
    "userId": "d60347da-da6f-4d3e-8adc-0bcdbba53692",
    "token": "eyJhbGciOiJIUzI1NiJ9...",
    "refreshToken": "eyJhbGciOiJIUzI1NiJ9...",
    "expiresIn": 7200,
    "userInfo": {
      "userId": "d60347da-da6f-4d3e-8adc-0bcdbba53692",
      "phone": "13800138000",
      "email": null,
      "username": "用户8000",
      "avatar": "https://api.dicebear.com/7.x/initials/svg?seed=用户8000",
      "gender": 0,
      "birthday": null,
      "bio": null,
      "loginType": "phone",
      "createdAt": "2025-11-16T10:00:00"
    }
  }
}
```

**data字段类型**: `LoginResponse`

**LoginResponse 字段说明**:
| 字段 | 类型 | 说明 | 示例 |
|------|------|------|------|
| userId | string | 用户唯一ID（UUID格式） | "d60347da-da6f-4d3e-8adc-0bcdbba53692" |
| token | string | 访问令牌（JWT），有效期2小时 | "eyJhbGciOiJIUzI1NiJ9..." |
| refreshToken | string | 刷新令牌（JWT），有效期30天 | "eyJhbGciOiJIUzI1NiJ9..." |
| expiresIn | number | 令牌有效期（秒） | 7200 |
| userInfo | UserInfo | 用户详细信息对象 | 见下方UserInfo |

**UserInfo 字段说明**:
| 字段 | 类型 | 必填 | 说明 | 示例 | 备注 |
|------|------|------|------|------|------|
| userId | string | ✅ | 用户唯一ID | "d60347da..." | UUID格式 |
| phone | string \| null | ❌ | 手机号 | "13800138000" | 可能被隐私过滤 |
| email | string \| null | ❌ | 邮箱地址 | "user@example.com" | 可能被隐私过滤 |
| username | string | ✅ | 用户昵称 | "用户8000" | 最大20字符 |
| avatar | string | ✅ | 头像URL | "http://..." | 完整URL |
| gender | number | ✅ | 性别 | 0 | 0-未知, 1-男, 2-女 |
| birthday | string \| null | ❌ | 生日 | "1990-01-01" | yyyy-MM-dd格式 |
| bio | string \| null | ❌ | 个人简介 | "这是我的简介" | 最大200字符 |
| loginType | string | ✅ | 注册方式 | "phone" | phone或email |
| createdAt | string | ✅ | 注册时间 | "2025-11-16T10:00:00" | ISO 8601格式 |

---

#### 2.4 密码登录 - `POST /api/auth/login`

响应格式同 2.3（手机号登录）

---

#### 2.5 用户注册 - `POST /api/auth/register`

响应格式同 2.3（手机号登录）

---

#### 2.6 获取用户信息 - `GET /api/auth/user/{userId}`

```json
{
  "code": 200,
  "message": "获取成功",
  "data": {
    "userId": "d60347da-da6f-4d3e-8adc-0bcdbba53692",
    "phone": "138****8000",
    "email": null,
    "username": "用户昵称",
    "avatar": "https://api.dicebear.com/7.x/initials/svg?seed=用户昵称",
    "gender": 1,
    "birthday": "1990-01-01",
    "bio": "这是我的个人简介",
    "loginType": "phone",
    "createdAt": "2025-11-16T10:00:00"
  }
}
```

**data字段类型**: `UserInfo`（字段说明见2.3）

**注意**: 根据隐私设置和requesterId，部分字段可能被过滤或脱敏

---

#### 2.7 更新用户信息 - `PUT /api/auth/user/{userId}`

响应格式同 2.6（获取用户信息）

---

#### 2.8 刷新Token - `POST /api/auth/refresh`

```json
{
  "code": 200,
  "message": "刷新成功",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiJ9...",
    "refreshToken": "eyJhbGciOiJIUzI1NiJ9...",
    "expiresIn": 7200
  }
}
```

**data字段类型**: `RefreshTokenResponse`

**RefreshTokenResponse 字段说明**:
| 字段 | 类型 | 说明 | 示例 |
|------|------|------|------|
| token | string | 新的访问令牌 | "eyJhbGciOiJIUzI1NiJ9..." |
| refreshToken | string | 新的刷新令牌 | "eyJhbGciOiJIUzI1NiJ9..." |
| expiresIn | number | 令牌有效期（秒） | 7200 |

---

### 3. 头像管理响应格式

#### 3.1 上传头像 - `POST /api/avatar/upload`

```json
{
  "code": 200,
  "message": "上传成功",
  "data": {
    "avatarUrl": "http://localhost:8080/api/files/avatars/d60347da_1732434000123.jpg"
  }
}
```

**data字段类型**: `Object`

**字段说明**:
| 字段 | 类型 | 说明 | 示例 |
|------|------|------|------|
| avatarUrl | string | 头像完整URL | "http://localhost:8080/api/files/avatars/xxx.jpg" |

---

#### 3.2 删除头像 - `DELETE /api/avatar/{userId}`

```json
{
  "code": 200,
  "message": "删除成功",
  "data": null
}
```

**data字段类型**: `null`

---

### 4. 隐私设置响应格式

#### 4.1 获取隐私设置 - `GET /api/privacy/settings/{userId}`

```json
{
  "code": 200,
  "message": "获取成功",
  "data": [
    {
      "fieldName": "phone",
      "displayName": "手机号",
      "visibilityLevel": "PRIVATE"
    },
    {
      "fieldName": "email",
      "displayName": "邮箱",
      "visibilityLevel": "FRIENDS_ONLY"
    },
    {
      "fieldName": "birthday",
      "displayName": "生日",
      "visibilityLevel": "FRIENDS_ONLY"
    },
    {
      "fieldName": "gender",
      "displayName": "性别",
      "visibilityLevel": "PUBLIC"
    },
    {
      "fieldName": "bio",
      "displayName": "个人简介",
      "visibilityLevel": "PUBLIC"
    }
  ]
}
```

**data字段类型**: `Array<PrivacySettingDTO>`

**PrivacySettingDTO 字段说明**:
| 字段 | 类型 | 说明 | 可选值 |
|------|------|------|--------|
| fieldName | string | 字段名 | phone, email, birthday, gender, bio |
| displayName | string | 字段显示名称 | "手机号", "邮箱", "生日", "性别", "个人简介" |
| visibilityLevel | string | 可见性级别 | PUBLIC, FRIENDS_ONLY, PRIVATE |

---

#### 4.2 更新隐私设置 - `PUT /api/privacy/settings/{userId}`

```json
{
  "code": 200,
  "message": "更新成功",
  "data": null
}
```

**data字段类型**: `null`

---

#### 4.3 清除隐私缓存 - `DELETE /api/privacy/cache/{userId}`

```json
{
  "code": 200,
  "message": "缓存已清除",
  "data": null
}
```

**data字段类型**: `null`

---

### 5. 日程管理响应格式

#### 5.1 获取指定月份的日程 - `GET /api/schedules`

```json
{
  "code": 200,
  "message": "获取成功",
  "data": [
    {
      "scheduleId": "schedule-uuid-1",
      "userId": "user-uuid",
      "groupId": null,
      "title": "团队会议",
      "scheduleDate": "2024-07-15",
      "startTime": "14:00",
      "endTime": "15:30",
      "location": "会议室A",
      "isAllDay": false,
      "createdAt": 1732434000000
    },
    {
      "scheduleId": "schedule-uuid-2",
      "userId": "user-uuid",
      "groupId": "group-uuid",
      "title": "全天活动",
      "scheduleDate": "2024-07-20",
      "startTime": null,
      "endTime": null,
      "location": null,
      "isAllDay": true,
      "createdAt": 1732434000000
    }
  ]
}
```

**data字段类型**: `Array<ScheduleDTO>`

**ScheduleDTO 字段说明**:
| 字段 | 类型 | 必填 | 说明 | 示例 |
|------|------|------|------|------|
| scheduleId | string | ✅ | 日程唯一ID | "schedule-uuid-1" |
| userId | string | ✅ | 创建者用户ID | "user-uuid" |
| groupId | string \| null | ❌ | 关联的群组ID | "group-uuid" 或 null |
| title | string | ✅ | 日程标题 | "团队会议" |
| scheduleDate | string | ✅ | 日程日期 | "2024-07-15" (yyyy-MM-dd) |
| startTime | string \| null | ❌ | 开始时间 | "14:00" (HH:mm) |
| endTime | string \| null | ❌ | 结束时间 | "15:30" (HH:mm) |
| location | string \| null | ❌ | 日程地点 | "会议室A" |
| isAllDay | boolean | ✅ | 是否全天 | true 或 false |
| createdAt | number | ✅ | 创建时间戳（毫秒） | 1732434000000 |

---

#### 5.2 创建新日程 - `POST /api/schedules`

响应格式同 5.1，返回单个 `ScheduleDTO` 对象

```json
{
  "code": 200,
  "message": "创建成功",
  "data": {
    "scheduleId": "schedule-uuid",
    "userId": "user-uuid",
    "groupId": null,
    "title": "新日程",
    "scheduleDate": "2024-07-15",
    "startTime": "14:00",
    "endTime": "15:30",
    "location": "会议室A",
    "isAllDay": false,
    "createdAt": 1732434000000
  }
}
```

**data字段类型**: `ScheduleDTO`

---

#### 5.3 更新日程 - `PUT /api/schedules/{scheduleId}`

响应格式同 5.2（创建新日程）

---

#### 5.4 删除日程 - `DELETE /api/schedules/{scheduleId}`

```json
{
  "code": 200,
  "message": "删除成功",
  "data": null
}
```

**data字段类型**: `null`

---

### 6. 群组管理响应格式

#### 6.1 创建群组 - `POST /api/groups`

```json
{
  "id": "group-uuid",
  "name": "我的群组",
  "ownerId": "user-uuid",
  "invitationCode": "ABC123"
}
```

**⚠️ 注意**: 此接口不使用统一的ApiResponse格式

**GroupResponse 字段说明**:
| 字段 | 类型 | 说明 | 示例 |
|------|------|------|------|
| id | string | 群组唯一ID | "group-uuid" |
| name | string | 群组名称 | "我的群组" |
| ownerId | string | 群主用户ID | "user-uuid" |
| invitationCode | string | 邀请码 | "ABC123" |

---

#### 6.2 加入群组 - `POST /api/groups/{groupId}/join`

响应格式同 6.1（创建群组）

---

#### 6.3 获取我加入的群组列表 - `GET /api/groups/my`

```json
[
  {
    "groupId": "group-uuid-1",
    "groupName": "群组1",
    "role": "owner"
  },
  {
    "groupId": "group-uuid-2",
    "groupName": "群组2",
    "role": "member"
  }
]
```

**⚠️ 注意**: 此接口不使用统一的ApiResponse格式，直接返回数组

**MyGroupResponse 字段说明**:
| 字段 | 类型 | 说明 | 示例 |
|------|------|------|------|
| groupId | string | 群组ID | "group-uuid-1" |
| groupName | string | 群组名称 | "群组1" |
| role | string | 用户在群组中的角色 | "owner" 或 "member" |

---

#### 6.4 获取群组详情 - `GET /api/groups/{groupId}`

```json
{
  "id": "group-uuid",
  "name": "我的群组",
  "ownerId": "user-uuid",
  "currentUserRole": "owner",
  "invitationCode": "ABC123",
  "members": [
    {
      "userId": "user-uuid-1",
      "username": "用户1",
      "role": "owner"
    },
    {
      "userId": "user-uuid-2",
      "username": "用户2",
      "role": "member"
    }
  ]
}
```

**⚠️ 注意**: 此接口不使用统一的ApiResponse格式

**GroupDetailResponse 字段说明**:
| 字段 | 类型 | 说明 | 示例 |
|------|------|------|------|
| id | string | 群组ID | "group-uuid" |
| name | string | 群组名称 | "我的群组" |
| ownerId | string | 群主ID | "user-uuid" |
| currentUserRole | string | 当前用户角色 | "owner" 或 "member" |
| invitationCode | string | 邀请码 | "ABC123" |
| members | Array<GroupMemberDTO> | 成员列表 | 见下方 |

**GroupMemberDTO 字段说明**:
| 字段 | 类型 | 说明 | 示例 |
|------|------|------|------|
| userId | string | 用户ID | "user-uuid-1" |
| username | string | 用户昵称 | "用户1" |
| role | string | 角色 | "owner" 或 "member" |

---

### 7. AI聊天响应格式

#### 7.1 获取聊天会话列表 - `GET /api/ai/chat/sessions`

```json
{
  "code": 200,
  "message": "获取成功",
  "data": [
    {
      "id": "session-uuid-1",
      "title": "今天的天气如何",
      "lastMessage": "今天天气晴朗，气温...",
      "timestamp": 1732434000000
    },
    {
      "id": "session-uuid-2",
      "title": "帮我写一段代码",
      "lastMessage": "好的，这是一段Python代码...",
      "timestamp": 1732434100000
    }
  ]
}
```

**data字段类型**: `Array<ChatSessionDTO>`

**ChatSessionDTO 字段说明**:
| 字段 | 类型 | 说明 | 示例 |
|------|------|------|------|
| id | string | 会话唯一ID | "session-uuid-1" |
| title | string | 会话标题 | "今天的天气如何" |
| lastMessage | string | 最后一条消息预览 | "今天天气晴朗，气温..." |
| timestamp | number | 最后消息时间戳（毫秒） | 1732434000000 |

---

#### 7.2 发送消息 - `POST /api/ai/chat/message`

```json
{
  "code": 200,
  "message": "发送成功",
  "data": {
    "sessionId": "session-uuid",
    "message": "这是AI的回复内容",
    "timestamp": 1732434000000
  }
}
```

**data字段类型**: `ChatMessageResponse`

**ChatMessageResponse 字段说明**:
| 字段 | 类型 | 说明 | 示例 |
|------|------|------|------|
| sessionId | string | 会话ID | "session-uuid" |
| message | string | AI回复的消息内容 | "这是AI的回复内容" |
| timestamp | number | 消息时间戳（毫秒） | 1732434000000 |

---

#### 7.3 获取聊天记录 - `GET /api/ai/chat/history/{sessionId}`

```json
{
  "code": 200,
  "message": "获取成功",
  "data": {
    "messages": [
      {
        "id": "message-uuid-1",
        "content": "你好",
        "role": "user",
        "timestamp": 1732434000000
      },
      {
        "id": "message-uuid-2",
        "content": "你好！有什么我可以帮助你的吗？",
        "role": "assistant",
        "timestamp": 1732434001000
      }
    ]
  }
}
```

**data字段类型**: `ChatHistoryResponse`

**ChatHistoryResponse 字段说明**:
| 字段 | 类型 | 说明 |
|------|------|------|
| messages | Array<ChatHistoryMessageDTO> | 消息列表 |

**ChatHistoryMessageDTO 字段说明**:
| 字段 | 类型 | 说明 | 示例 |
|------|------|------|------|
| id | string | 消息唯一ID | "message-uuid-1" |
| content | string | 消息内容 | "你好" |
| role | string | 角色 | "user" 或 "assistant" |
| timestamp | number | 消息时间戳（毫秒） | 1732434000000 |

---

#### 7.4 创建新会话 - `POST /api/ai/chat/sessions`

响应格式同 7.1，返回单个 `ChatSessionDTO` 对象

```json
{
  "code": 200,
  "message": "创建成功",
  "data": {
    "id": "session-uuid",
    "title": "新对话",
    "lastMessage": "",
    "timestamp": 1732434000000
  }
}
```

**data字段类型**: `ChatSessionDTO`

---

### 8. 活动消息响应格式

#### 8.1 获取活动消息列表 - `GET /api/activity/messages`

```json
{
  "code": 200,
  "message": "获取成功",
  "data": {
    "unreadCount": 3,
    "total": 10,
    "page": 1,
    "pageSize": 10,
    "messages": [
      {
        "id": "msg-uuid-1",
        "title": "新功能上线",
        "content": "我们上线了全新的AI助手功能",
        "imageUrl": "http://example.com/image.jpg",
        "tag": "功能更新",
        "linkType": "webview",
        "linkUrl": "http://example.com/details",
        "isRead": false,
        "createdAt": "2025-12-01T10:00:00"
      }
    ]
  }
}
```

**data字段类型**: `ActivityMessageListResponse`

**ActivityMessageListResponse 字段说明**:
| 字段 | 类型 | 说明 | 示例 |
|------|------|------|------|
| unreadCount | number | 未读消息数量 | 3 |
| total | number | 总消息数 | 10 |
| page | number | 当前页码 | 1 |
| pageSize | number | 每页数量 | 10 |
| messages | Array<ActivityMessageDTO> | 消息列表 | 见下方 |

**ActivityMessageDTO 字段说明**:
| 字段 | 类型 | 说明 | 示例 |
|------|------|------|------|
| id | string | 消息ID | "msg-uuid-1" |
| title | string | 标题 | "新功能上线" |
| content | string | 内容描述 | "我们上线了全新的AI助手功能" |
| imageUrl | string | 图片URL | "http://example.com/image.jpg" |
| tag | string | 标签 | "功能更新" |
| linkType | string | 链接类型 | "none", "internal", "webview" |
| linkUrl | string | 跳转链接 | "http://example.com/details" |
| isRead | boolean | 是否已读 | true 或 false |
| createdAt | string | 创建时间 | "2025-12-01T10:00:00" (ISO 8601) |

---

#### 8.2 获取未读消息数量 - `GET /api/activity/unread-count`

```json
{
  "code": 200,
  "message": "获取成功",
  "data": {
    "unreadCount": 5
  }
}
```

**data字段类型**: `UnreadCountResponse`

**UnreadCountResponse 字段说明**:
| 字段 | 类型 | 说明 | 示例 |
|------|------|------|------|
| unreadCount | number | 未读消息数量 | 5 |

---

#### 8.3 标记消息已读 - `PUT /api/activity/messages/{messageId}/read`

```json
{
  "code": 200,
  "message": "标记成功",
  "data": null
}
```

**data字段类型**: `null`

---

#### 8.4 标记全部已读 - `PUT /api/activity/messages/read-all`

```json
{
  "code": 200,
  "message": "全部标记成功",
  "data": {
    "readCount": 5
  }
}
```

**data字段类型**: `ReadAllResponse`

**ReadAllResponse 字段说明**:
| 字段 | 类型 | 说明 | 示例 |
|------|------|------|------|
| readCount | number | 标记已读的消息数量 | 5 |

---

### 9. 文件访问响应格式

#### 9.1 访问头像文件 - `GET /api/files/avatars/{filename}`

直接返回二进制文件流，不使用JSON格式

**响应类型**: `image/jpeg` 或 `image/png` 或 `image/webp`

**Headers**:
- `Content-Type`: image/jpeg | image/png | image/webp
- `Cache-Control`: max-age=31536000

---

### 10. 错误响应格式

所有错误响应遵循统一格式：

```json
{
  "code": 400,
  "message": "错误信息描述",
  "data": null
}
```

**常见错误码**:
| 状态码 | 说明 | 示例场景 |
|--------|------|----------|
| 400 | 请求参数错误 | 参数格式不正确、验证失败 |
| 401 | 未授权 | Token无效或过期 |
| 403 | 无权限访问 | 访问其他用户的私密信息 |
| 404 | 资源不存在 | 用户不存在、文件不存在 |
| 409 | 资源冲突 | 用户已在群组中 |
| 413 | 请求体过大 | 上传文件超过5MB |
| 429 | 请求过于频繁 | 验证码发送频率超限 |
| 500 | 服务器内部错误 | 数据库错误、文件系统错误 |

---

### 11. TypeScript类型定义

为方便前端开发，以下是完整的TypeScript类型定义：

```typescript
// ============ 通用类型 ============
interface ApiResponse<T> {
  code: number;
  message: string;
  data: T | null;
}

// ============ 用户相关 ============
interface UserInfo {
  userId: string;
  phone: string | null;
  email: string | null;
  username: string;
  avatar: string;
  gender: number; // 0-未知, 1-男, 2-女
  birthday: string | null; // yyyy-MM-dd
  bio: string | null;
  loginType: string; // "phone" | "email"
  createdAt: string; // ISO 8601
}

interface LoginResponse {
  userId: string;
  token: string;
  refreshToken: string;
  expiresIn: number;
  userInfo: UserInfo;
}

interface RefreshTokenResponse {
  token: string;
  refreshToken: string;
  expiresIn: number;
}

// ============ 隐私设置 ============
interface PrivacySettingDTO {
  fieldName: string; // "phone" | "email" | "birthday" | "gender" | "bio"
  displayName: string;
  visibilityLevel: "PUBLIC" | "FRIENDS_ONLY" | "PRIVATE";
}

// ============ 日程相关 ============
interface ScheduleDTO {
  scheduleId: string;
  userId: string;
  groupId: string | null;
  title: string;
  scheduleDate: string; // yyyy-MM-dd
  startTime: string | null; // HH:mm
  endTime: string | null; // HH:mm
  location: string | null;
  isAllDay: boolean;
  createdAt: number; // 时间戳（毫秒）
}

// ============ 群组相关 ============
interface GroupResponse {
  id: string;
  name: string;
  ownerId: string;
  invitationCode: string;
}

interface MyGroupResponse {
  groupId: string;
  groupName: string;
  role: "owner" | "member";
}

interface GroupDetailResponse {
  id: string;
  name: string;
  ownerId: string;
  currentUserRole: "owner" | "member";
  invitationCode: string;
  members: GroupMemberDTO[];
}

interface GroupMemberDTO {
  userId: string;
  username: string;
  role: "owner" | "member";
}

// ============ AI聊天相关 ============
interface ChatSessionDTO {
  id: string;
  title: string;
  lastMessage: string;
  timestamp: number; // 时间戳（毫秒）
}

interface ChatMessageResponse {
  sessionId: string;
  message: string;
  timestamp: number; // 时间戳（毫秒）
}

interface ChatHistoryResponse {
  messages: ChatHistoryMessageDTO[];
}

interface ChatHistoryMessageDTO {
  id: string;
  content: string;
  role: "user" | "assistant";
  timestamp: number; // 时间戳（毫秒）
}

// ============ 活动消息相关 ============
interface ActivityMessageListResponse {
  unreadCount: number;
  total: number;
  page: number;
  pageSize: number;
  messages: ActivityMessageDTO[];
}

interface ActivityMessageDTO {
  id: string;
  title: string;
  content: string;
  imageUrl: string;
  tag: string;
  linkType: "none" | "internal" | "webview";
  linkUrl: string;
  isRead: boolean;
  createdAt: string; // ISO 8601
}

interface UnreadCountResponse {
  unreadCount: number;
}

interface ReadAllResponse {
  readCount: number;
}

// ============ 其他 ============
interface UploadAvatarResponse {
  avatarUrl: string;
}
```

---

## 文档更新记录

| 版本 | 日期 | 更新内容 | 作者 |
|------|------|----------|------|
| v1.0 | 2025-11-24 | 初始版本，包含所有已实现接口 | Claude Code |
| v1.1 | 2025-12-17 | 添加完整API响应格式详细说明章节 | GitHub Copilot |

---

**文档结束**

如有疑问或发现问题，请联系后端开发团队。